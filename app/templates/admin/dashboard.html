{% extends "base.html" %}

{% block content %}
<style>
    body {
        background: #F5F5F5 !important;
        margin: 0;
        font-family: Arial, sans-serif;
    }

    .app-container {
        flex-direction: column;
        min-height: 100vh;
        display: flex;
    }

    .sidebar {
        display: none;
    }

    .content {
        padding: 0;
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: #F5F5F5;
    }

    /* Header */
    .top-header {
        background-color: #990000;
        color: white;
        padding: 0.5rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 60px;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .user-avatar {
        width: 32px;
        height: 32px;
        background-color: #FFD700;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #333;
    }

    .center-logo img {
        height: 40px;
    }

    .header-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .header-actions a {
        position: relative;
        display: inline-block;
    }

    .header-actions img {
        width: 28px;
        height: 28px;
        cursor: pointer;
        filter: brightness(0) invert(1);
        transition: transform 0.3s ease;
    }

    .header-actions a:hover img {
        transform: scale(1.1);
    }


    /* Main Content */
    .main-body {
        flex: 1;
        padding: 2rem;
        max-width: 1200px;
        margin: 0 auto;
        width: 100%;
    }

    .page-title {
        text-align: center;
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 1.5rem;
        color: #00000;
    }

    .filter-section {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 2rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }

    .filter-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .filter-item label {
        font-weight: 600;
        color: #000;
    }

    .filter-item input {
        width: 80px;
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        text-align: center;
        font-weight: 600;
        color: #727272;
    }

    .btn-search {
        background-color: white;
        border: 1px solid #990000;
        padding: 0.5rem 0.75rem;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-search img {
        width: 20px;
        height: 20px;
    }

    .chart-section {
        background: white;
        padding: 0;
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .section-header {
        background-color: #990000;
        color: white;
        text-align: center;
        padding: 0.75rem;
        font-weight: bold;
        font-size: 1rem;
    }

    .section-subtitle {
        text-align: center;
        padding: 0.75rem;
        font-weight: 600;
        color: #666;
        border-bottom: 1px solid #eee;
    }

    .chart-container {
        height: 350px;
        background-color: #E0E0E0;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    .revenue-display {
        padding: 1rem;
        text-align: center;
        border-top: 1px solid #eee;
        font-weight: 600;
        color: #333;
    }

    .two-column-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .chart-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .pie-chart-container {
        height: 300px;
        background-color: #E0E0E0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        position: relative;
    }

    @media (max-width: 968px) {
        .two-column-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="top-header">
    <div class="user-info">
        <div class="user-avatar">
            <img src="https://ui-avatars.com/api/?name={{ session.get('username', 'User') }}&background=random"
                 alt="User" style="border-radius: 50%; width: 100%; height: 100%;">
        </div>
        <span>Hello, {{ session.get('username', 'User') }}</span>
    </div>

    <div class="center-logo">
        <img src="{{ url_for('static', filename='images/logo-white.png') }}" alt="CRC">
    </div>

    <div class="header-actions">
        <a href="{{ url_for('admin.accessories') }}">
            <img src="{{ url_for('static', filename='images/secure.png') }}"
                 alt="Accessories"
                 style="width: 30px; height: auto; cursor: pointer;">
        </a>
        <a href="{{ url_for('main.logout') }}">
            <img src="{{ url_for('static', filename='images/logout.png') }}"
                 alt="Logout"
                 style="width: 30px; height: 32px; cursor: pointer;">
        </a>

    </div>
</div>


<div class="main-body">
    <div class="page-title">Statistics for {{ filter_month }} / {{ filter_year }}</div>

    <form method="GET" action="{{ url_for('admin.dashboard') }}" class="filter-section">
        <div class="filter-item">
            <label>Day:</label>
            <input type="text" name="day" value="{{ filter_day if filter_day else '' }}" placeholder="---">
        </div>
        <div class="filter-item">
            <label>Month:</label>
            <input type="number" name="month" value="{{ filter_month }}" min="1" max="12" required>
        </div>
        <div class="filter-item">
            <label>Year:</label>
            <input type="number" name="year" value="{{ filter_year }}" min="2000" max="2100" required>
        </div>
        <button type="submit" class="btn-search">
            <img src="https://cdn-icons-png.flaticon.com/512/149/149852.png" alt="Search">
        </button>
    </form>

    <div class="chart-section">
        <div class="section-header">Store revenue</div>
        <div class="section-subtitle">Daily revenue (or Monthly)</div>

        <div class="chart-container">
            <canvas id="revenueChart"></canvas>
        </div>

        <div class="revenue-display">
            Revenue = {{ "{:,.0f}".format(total_revenue) }}
        </div>
    </div>

    <div class="two-column-grid">
        <div class="chart-card">
            <div class="section-header">Ratio of vehicle types</div>
            <div class="pie-chart-container">
                <canvas id="vehicleTypesChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="section-header">Common Error Chart</div>
            <div class="pie-chart-container">
                <canvas id="errorChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

<script>
// Update notification badge count
function updateNotificationBadge() {
    fetch('{{ url_for("admin.low_stock_count") }}')
        .then(response => response.json())
        .then(data => {
            const badge = document.getElementById('notification-badge');
            if (badge) {
                badge.textContent = data.count;
                if (data.count === 0) {
                    badge.classList.add('zero');
                } else {
                    badge.classList.remove('zero');
                }
            }
        })
        .catch(error => console.error('Error:', error));
}

document.addEventListener('DOMContentLoaded', function() {
    // Update notification badge
    updateNotificationBadge();
    setInterval(updateNotificationBadge, 60000); // Update every 60 seconds

    // Charts code (same as before)
    {% if chart_data %}
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    new Chart(revenueCtx, {
        type: 'bar',
        data: {
            labels: [
                {% for data in chart_data %}
                'Day {{ data.day }}'{{ ',' if not loop.last else '' }}
                {% endfor %}
            ],
            datasets: [{
                label: 'Revenue (VND)',
                data: [
                    {% for data in chart_data %}
                    {{ data.revenue }}{{ ',' if not loop.last else '' }}
                    {% endfor %}
                ],
                backgroundColor: '#990000',
                borderColor: '#770000',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Revenue: ' + context.parsed.y.toLocaleString() + ' VND';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
    {% endif %}

    {% if vehicle_stats %}
    const vehicleCtx = document.getElementById('vehicleTypesChart').getContext('2d');
    new Chart(vehicleCtx, {
        type: 'pie',
        data: {
            labels: [{% for v in vehicle_stats %}'{{ v.type }}'{{ ',' if not loop.last }}{% endfor %}],
            datasets: [{
                data: [{% for v in vehicle_stats %}{{ v.count }}{{ ',' if not loop.last }}{% endfor %}],
                backgroundColor: ['#990000', '#CC0000', '#FF3333', '#FF6666', '#FF9999']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
    {% endif %}

    {% if category_stats %}
    const errorCtx = document.getElementById('errorChart').getContext('2d');
    new Chart(errorCtx, {
        type: 'bar',
        data: {
            labels: [{% for c in category_stats %}'{{ c.category }}'{{ ',' if not loop.last }}{% endfor %}],
            datasets: [{
                data: [{% for c in category_stats %}{{ c.count }}{{ ',' if not loop.last }}{% endfor %}],
                backgroundColor: ['#990000', '#CC0000', '#FF3333', '#003366', '#0055AA']
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { beginAtZero: true } }
        }
    });
    {% endif %}
});
</script>
{% endblock %}